<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
    <script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=59b7bde77496d4668dfdddc31a4207fc"></script>
    <title>Document</title>
    <link rel = "stylesheet" href = "css/main.css">    
    <script src = "script/mainScript.js"></script>
</head>
<body>
    <img src = "img2/bank_white.png" class = "decoration">
    <img src = "img2/review_white.png" class = "decoration">
    <img src = "img2/restaurant_white.png" class = "decoration">
    <img src = "img2/information_white.png" class = "decoration">
    <img src = "img2/eiffel-tower_white.png" class = "decoration">
    <img src = "img2/serving-dish_white.png" class = "decoration">


    <!-- Navbar 태그 -->
    <div id="searchNavbar">
        <div class="search cursor">X</div>
        <input type = "text" placeholder="검색하기">
        <img src = "img2/search2.png" id = "getSearch" class = "cursor">
    </div>
    <div id="mainNavbar" class = "bottom-shadow">
        <div id = "logo" class = "cursor">Hot Place</div>
        <div id = "navbar_middle">
            <div class = "cursor"><img src = "img2/restaurant2.png">맛집</div>
            <div class = "cursor"><img src = "img2/bank2.png" >은행</div>
            <div class = "cursor" onclick = "location.href = `/recommand`"><img src = "img2/quality.png">추천</div>
        </div>
        <div id = "navbar_right">
            <img src = "img2/moon.png" class = "cursor" id = "mode">
            <img src = "img2/user2.png" id = "userInfo" class = "cursor">
            <img src = "img2/search2.png" class = "search cursor">
        </div>
    </div>


    <div id = "logo_slow">
        <div>주변의</div>
        <div><span>핫플레이스</span>를</div>
        <div>손쉽게 찾아보세요!</div>
    </div>

    <!-- 탑 로고 -->
    <div id="topLogo">
        <div id = "navi">스크롤을 내려 확인하세요!</div>
    </div>

    <div id = "wave" style="height: 150px; overflow: hidden;">
        <svg viewBox="0 0 500 150" preserveAspectRatio="none" style="height: 100%; width: 100%;">
          <path d="M0.00,92.27 C216.83,192.92 304.30,8.39 500.00,109.03 L500.00,0.00 L0.00,0.00 Z" style="stroke: none;fill: rgb(34,34,49);"></path>
        </svg>
    </div>


    <!-- 지도 메뉴 태그 -->
    <div class="floating-container" id = "toggleBtn">
        <div class="floating-button">+</div>
        <div class="element-container">

            <a href="#" onclick = "showBank()"> 
                <span class="float-element tooltip-left">
                    <img src = "img2/bank_white.png">
                </span>
            </a>
            <a href = "#" class="float-element tooltip-left" onclick = "showMarket()">
                <img src = "img2/restaurant_white.png">
            </a>
            <span class="float-element" onclick = "hideMarkers();">
                <img src = "img2/delete.png">
            </span>
        </div>
    </div>


    <!-- 위로가기 버튼, 지도로 전환 버튼 -->
    <img src = "img2/up-arrow.png" id = "up">
    <img src = "img2/map.png" id="changeToMap">


    <!-- 화면 로딩 태그 -->
    <div class="loader"></div>
    <div id="loadback"></div>
    

    <!-- 화면 전환 태그 -->
    <div class="right-layer"></div>
    <div class="right-layer right-layer--2"></div>
    <div class="right-layer right-layer--3"></div>


    <!-- 지도 태그 -->
    <div id="map">

    </div>

    
    

    <!-- 내용 담기는 태그 -->
    <div id="container">
        
        
    </div>
</body>
<script>

    var mapContainer = document.getElementById('map'),  // 맵 div받기
        mapOption = { 
            center: new kakao.maps.LatLng(35.1542163, 129.0671883), // 지도 중심좌표
            level: 3 // 지도의 확대 레벨
        };

        var map = new kakao.maps.Map(mapContainer, mapOption); // 지도를 생성

        if(navigator.geolocation) {
            
            navigator.geolocation.getCurrentPosition(function(position) {
                let arr = [];
                // 위치를 가져오는데 성공할 경우
                $.each(position.coords, function(key, item) {
                    arr[key] = item;
                });
    
                // 위치를 전역으로 생성
                moveLatLon = new kakao.maps.LatLng(arr['latitude'],arr['longitude']);
                map.setCenter(moveLatLon);

                var imageSrc = `img2/location-pin4.png`
                

                imageSize = new kakao.maps.Size(50, 50), // 마커이미지의 크기입니다
                imageOption = {offset: new kakao.maps.Point(27, 69)}; // 마커이미지의 옵션입니다. 마커의 좌표와 일치시킬 이미지 안에서의 좌표를 설정합니다.
                
                // 마커의 이미지정보를 가지고 있는 마커이미지를 생성합니다
                var markerImage = new kakao.maps.MarkerImage(imageSrc, imageSize, imageOption);
                /*marker image */

                var infowindow = new kakao.maps.InfoWindow({
                    content: "현재 내위치" // 인포윈도우에 표시할 내용
                });
                

                // 마커를 생성
                var marker = new kakao.maps.Marker({
                    position: moveLatLon,
                    image: markerImage, // 마커이미지 설정 
                });
            
                // 마커가 지도 위에 표시되도록 설정합니다
                marker.setMap(map);
                kakao.maps.event.addListener(marker, 'mouseover', makeOverListener(map, marker, infowindow));
                kakao.maps.event.addListener(marker, 'mouseout', makeOutListener(infowindow));

            }, function(error) {
                
                // 위치를 가져오는데 실패한 경우
                console.log(error.message);
                console.log('위치를 찾지 못했습니다. 기본 좌표는 부산은행 연수원입니다.')
            });
        } else {
            consol.log("Geolocation을 지원하지 않는 브라우저 입니다.");
        }

        var markers = [];

 

        function addMarker(info) {
        	let curPos;
        	let content;
        	
        	if(info.bankAddress != null) {
        		curPos = new kakao.maps.LatLng(info.bankLat, info.bankLong);
                content = `
                    
                    <div class = "mapContent">
                        <middle>
                            <img src = 'img2/BNK.jpg'>
                        </middle>
                        <footer>
                            <div class = "mapContent_title">${info.bankName}</div>
                            <div>평균 가격 : 45,000</div>
                            <div>현재 웨이팅 수 : 5</div>
                            <div style = "color : red">★ 4.5</div>
                            <a href = "#">상세보기</a>
                        </footer>
                    </div>
                    
                    `
        	} else {
        		curPos = new kakao.maps.LatLng(info.shopLat, info.shopLong);
                content = `
                    
                    <div class = "mapContent">
                        <middle>
                            <img src = ${info.webAddress}>
                        </middle>
                        <footer>
                            <div class = "mapContent_title">${info.shopName}</div>
                            <div>평균 가격 : 45,000</div>
                            <div>현재 웨이팅 수 : 5</div>
                            <div style = "color : red">★ 4.5</div>
                            <a href = "#">상세보기</a>
                        </footer>
                    </div>
                    
                    `
        	}
        	
            
                var overlay = new kakao.maps.CustomOverlay({
                    content: content,
                    map: map,
                    position: curPos
                });
        
            /*marker image */
            var imageSrc;
            if(info.person > 10) imageSrc = '/img2/location-pin.png';
            else if(info.person > 5) imageSrc = '/img2/location-pin2.png';
            else imageSrc = '/img2/location-pin3.png';

            imageSize = new kakao.maps.Size(50, 50), // 마커이미지의 크기입니다
            imageOption = {offset: new kakao.maps.Point(27, 69)}; // 마커이미지의 옵션입니다. 마커의 좌표와 일치시킬 이미지 안에서의 좌표를 설정합니다.
            
            // 마커의 이미지정보를 가지고 있는 마커이미지를 생성합니다
            var markerImage = new kakao.maps.MarkerImage(imageSrc, imageSize, imageOption);
            /*marker image */
            

            // 마커를 생성
            var marker = new kakao.maps.Marker({
                position: curPos,
                image: markerImage, // 마커이미지 설정 
                toggle : false,
                originImage : imageSrc
            });
        
            // 마커가 지도 위에 표시되도록 설정합니다
            marker.setMap(map);
            
            // 생성된 마커를 배열에 추가합니다
            markers.push(marker);

            kakao.maps.event.addListener(marker, 'click', function() {
                marker.toggle = !marker.toggle;

                if(marker.toggle) {
                    overlay.setMap(map);
                }
                    
                else overlay.setMap(null);
            });
            overlay.setMap(null);

            // // 본인 위치 마커 생성
            // var marker = new kakao.maps.Marker({
            //     position: moveLatLon,
            // });
        }

        // 배열에 추가된 마커들을 지도에 표시하거나 삭제하는 함수입니다
        function setMarkers(map) {
            for (var i = 0; i < markers.length; i++) {
                markers[i].setMap(map);
            }            
        }

        // "마커 보이기" 버튼을 클릭하면 호출되어 배열에 추가된 마커를 지도에 표시하는 함수입니다
        function showMarkers() {
            setMarkers(map)    
        }

        // "마커 감추기" 버튼을 클릭하면 호출되어 배열에 추가된 마커를 지도에서 삭제하는 함수입니다
        function hideMarkers() {
            setMarkers(null);    
        }

        function showMarket() {
            hideMarkers();

            $.ajax({
            	url : '/shop/allShop',
            	type : 'get',
            	
            	success : (result) => {
            		for(let i = 0 ; i < result.length; i++)
            			addMarker(result[i]);
            	},
            	beforeSend : () => {
            		$('.loader').css('z-index',12);
    		        $("#loadback").css('z-index',11);
            	},
            	complete : () => {
            		setTimeout(() => {
    					$('.loader').css('z-index',-1);
    		            $("#loadback").css('z-index',-1);
    				},1000)
            	}
            })
        }

        function showBank() {
            hideMarkers();
       /*      for(let i = 0 ; i < marketInfo.length; i++) 
                addMarker(bankInfo[i]) */
                
            $.ajax({
            	url : '/bank/allBank',
            	type : 'get',
            	
            	success : (result) => {
            		console.log('받은 은행정보 : ',result);
            		for(let i = 0 ; i < result.length; i++)
            			addMarker(result[i]);
            	},
            	beforeSend : () => {
            		$('.loader').css('z-index',12);
    		        $("#loadback").css('z-index',11);
            	},
            	complete : () => {
            		setTimeout(() => {
    					$('.loader').css('z-index',-1);
    		            $("#loadback").css('z-index',-1);
    				},1000)
            	}
            })
        }

        // info열기
        function makeOverListener(map, marker, infowindow) {
            return function() {
                infowindow.open(map, marker);
            };
        }

        // info닫기
        function makeOutListener(infowindow) {
            return function() {
                infowindow.close();
            };
        }

        // 커스텀 오버레이를 닫기 위해 호출되는 함수입니다 
        function closeOverlay() {
            overlay.setMap(null);     
        }
</script>
</html>