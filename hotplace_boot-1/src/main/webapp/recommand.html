<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>오늘의 메뉴 추천</title>
    <link rel = "stylesheet" href= "css/recommand.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
    <script type="text/javascript" src="wScratchPad-master/wScratchPad.min.js"></script>    
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@9"></script>
    <script src="https://kit.fontawesome.com/5ea815c1d0.js"></script>
    <script src = "script/recommand.js"></script>
</head>
<body>
    <!-- navbar -->
    <div id="mainNavbar" class = "bottom-shadow">
        <div id = "logo"></div>
    </div>
    
    <!-- 캔버스 태그 -->
    <div id="canvas"></div>

    <!-- 웨이팅 버튼 -->
    <div class="my-btn" onclick = "">
        <div class="my-btn-border" onclick = ""></div>
        <div onclick = "" id = "redirBtn">웨이팅 하러가기</div>
    </div>

    <!-- 스크래치 유도 태그1 -->
    <div id="tap">
      <img src = "img2/tap.png" class = "disappear">
    </div>

    <!-- 선택사항 관련 태그 -->
    <div id="select_1">
        <div class = "info_text">
            <div class = "imfo_img">
                <img src = "img2/close.png">
            </div>
            <div class = "info_title">선택사항</div>
            <div>선택사항을 입력후</div>
            <div>추천 받으시겠습니까?</div>
        </div>
        <div class = "button_container">
            <div class = "cursor" id = "select_yes">YES</div>
            <div class = "cursor" id = "select_no">NO</div>
        </div>
    </div>

    <!-- 데이터 입력 태그 -->
    <div id="input_data">
        <form action = "recommand/registInfo" method = "get">
            <input type = "hidden" name = "userId" id = "userId_hidden" value="123">
            <input type = "text" name = "age" placeholder="연령" class = "full">
            <select class = "full" id = "marri_2">
                <option value = "">결혼유무 선택</option>
                <option value = "1">결혼</option>
                <option value = "2">미혼</option>
            </select>
            <select class = "full" id = "maritalStatus" name = "maritalStatus">
                <option value = "">배우자의 상태</option>
                <option value = "1">배우자가 있으며, 함께 살고 있음(사실혼 상태 포함)</option>
                <option value = "2">배우자가 있으나, 함께 살고 있지않음(출장 등의 일시적 상태 제외)
                <option value = "3">배우자 사망으로 배우자가 없음</option>
                <option value = "4">이혼으로 배우자가 없음</option>
            </select>
            <select class = "full" id = "nFamily" name = "nFamily">
                <option value = "">가구원수</option>
                <option value = "1">1명</option>
                <option value = "2">2명</option>
                <option value = "3">3명</option>
                <option value = "4">4명</option>
                <option value = "5">5명</option>
                <option value = "6">6명 이상</option>
            </select>
            <select class = "full" id = "generType" name = "generType">
                <option value = "">세대 유형</option>
                <option value = "1">1세대 가구 - 1인가구</option>
                <option value = "2">1세대 가구 - 부부</option>
                <option value = "3">1세대 가구 - 기타</option>
                <option value = "4">2세대 가구 - 부부 + 미혼자녀</option>
                <option value = "5">2세대 가구 - 편부모 + 미혼자녀</option>
                <option value = "6">2세대 가구 - 기타</option>
                <option value = "7">3세대 이상가구</option>
            </select>
            <select class = "full" id = "educ" name = "educ">
                <option value = "">교육 수준</option>
                <option value = "1">서당/한학</option>
                <option value = "2">무학</option>
                <option value = "3">초등학교</option>
                <option value = "4">중학교</option>
                <option value = "5">고등학교</option>
                <option value = "6">2년/3년제 대학</option>
                <option value = "7">4년제 대학</option>
                <option value = "8">대학원</option>
                <option value = "88">비해당(소아)</option>
            </select>
            <select class = "full" id = "job" name = "job">
                <option value = "">현재 직업</option>
                <option value = "1">관리자, 전문가 및 관련 종사자</option>
                <option value = "2">사무 종사자</option>
                <option value = "3">서비스 및 판매 종사자</option>
                <option value = "4">농림어업 숙련 종사자</option>
                <option value = "5">기능원, 장치 기계조작 및 조립 종사자</option>
                <option value = "6">단순 노무종사자</option>
                <option value = "7">무직(주부, 학생 등)</option>
            </select>
            <input type = "text" name = "ecMeantime" class = "full" placeholder="주당평균 근로시간">
            <select class = "full" id = "ecType" name = "ecType">
                <option value = "">근로시간 형태</option>
                <option value = "1">주간 근무</option>
                <option value = "2">저녁 근무(14:00 ~ 24:00)</option>
                <option value = "3">밤 근무(21:00 ~ 익일 am 8:00)</option>
                <option value = "4">주야간 규칙적 교대근무</option>
                <option value = "5">24시간 교대근무</option>
                <option value = "6">분할근무(하루 근무시간대 2개이상)</option>
                <option value = "7">불규칙 교대근무</option>
                <option value = "8">기타</option>
                <option value = "88">비해당(최근 1년간 일하지 않음)</option>
            </select>
            <select class = "full" id = "eatoutFreq" name = "eatoutFreq">
                <option value = "">외식 횟수</option>
                <option value = "1">하루 2회이상</option>
                <option value = "2">하루1회</option>
                <option value = "3">주 5~6회</option>
                <option value = "4">주 3~4회</option>
                <option value = "5">주 1~2회</option>
                <option value = "6">월 1~3회</option>
                <option value = "7">거의 안한다</option>
            </select>
            <button type = "submit">데이터 제출</button>
        </form>
    </div>  
    <!-- 스크래치 유도 태그2 -->
    <div id = "content" class = "disappear">화면을 긁어보세요!</div>
</body>
<script>
    // scratch함수 script파일 분리하면
    // 적용 제대로 안되 직접 작성

    // 특정 사진으로 오늘의 메뉴 추천
    // 현재 이미지 파일들을 추후 데이터 분석 & 추천으로 변경
    let pics = ['#foo','img2/wallpaper3.jpg','img2/wallpaper4.jpg','img2/wallpaper5.jpg','img2/wallpaper6.jpg','img2/wallpaper7.jpg']
    let shops = [5,0,1,2,3,4];
    let idx = 1;
    
    // 로고 클릭 (메인 연결)
    

    // 로딩시 이미지 세팅
    $(function() {        
        $('#logo').click(function(){
            location.href = "/login.html/bank"
        })

        // 가져온 함수 부분
        let isLogined = localStorage.getItem('loginUser')
        let user = null;
        if(isLogined)
            user = JSON.parse(localStorage.getItem('loginUser'));    
    
        // 로그인 되어있는 경우
        if(user) {
            let userId = user.userId;
            console.log('userId : 123',userId)
            $("#userId_hidden").attr('value',userId);
            
            isExist(userId)                    
        } else scratch(pics[0],pics[idx])
        
        
        $("#select_no").click(() => {
            $("#select_1").removeClass('appear')
            $("#select_1").css('z-index',-1)
        })

        $("#select_yes").click(() => {
            $("#select_1").removeClass('appear')
            $("#select_1").css('z-index',-1)
            $('#input_data').addClass('appear')
            $('#input_data').css('z-index',10)
        })

        $("#marri_2").on('change',function() {
            let chooseData = $(this).val()
            console.log(chooseData)

            if(chooseData == 1)
                $("#MARITAL_STATUS").css('display','block')
            else $("#MARITAL_STATUS").css('display','none')
        })


        $("#send_data").click(() => {
            //ajax써서 데이터 전송하기
            
            $('#input_data').removeClass('appear')
            $('#input_data').css('z-index',-1)
            Swal.fire(
                '데이터 입력',
                '성공적으로 입력되었습니다!',
                'success'
            )
            setTimeout(() => {location.reload()},1500)
        })
        // scratch(pics[0],pics[idx])
    })

    // 긁는 애니메이션 세팅 함수
    function scratch(item1,item2) {
        $('#canvas').wScratchPad({
            size        : 160,
            scratchDown : scratch,
            bg          : item2,
            fg          : item1,
            scratchMove : function(e,percent) {
              $(".my-btn").css('opacity',0)
              $(".my-btn").css('z-index',-1)

              $(".disappear").css('opacity',0)
            },
            scratchUp: function(e, percent)
            {
                if(percent > 50)
                {
                    console.log("percent > 50 pics : ",pics);
                    console.log(idx)
                    console.log(pics[idx])
                    $('#redirBtn').attr('onclick',`location.href = '/infoTemplate.html?category=shop&data=${shops[idx-1]}'`)
                    $('.my-btn').attr('onclick',`location.href = '/infoTemplate.html?category=shop&data=${shops[idx-1]}'`)
                    $('.my-btn-border').attr('onclick',`location.href = '/infoTemplate.html?category=shop&data=${shops[idx-1]}'`)

                    $("#canvas").fadeOut()
                    setTimeout(() => {
                        $("#canvas").fadeIn('100')
                        $(".my-btn").css('opacity','1')
                        $(".my-btn").css('z-index',10)
                    },1000)
                    $('#canvas').wScratchPad('reset')
                                .wScratchPad('fg',pics[idx])
                                .wScratchPad('bg',pics[++idx])
                    
                    $(this).scratch = false;
                }
            }
        });
    }

    let isExist = async(userId2) => new Promise((resolve,reject) => {
    $.ajax({
        type : 'post',
        url  : 'recommand/confirm',
        data : {'userId' : userId2},

        success : (result) => {
            console.log("받은 결과 : ",result)
            if(result.length == 0) {
                $("#select_1").addClass('appear')
                $("#select_1").css('z-index',10)
                scratch(pics[0],pics[idx])
            } 
            else {
                pics = ['#foo']     
                shops = []           
                for(let i = 0 ; i < result.length; i++) {
                    pics.push(result[i].webAddress)
                    shops.push(result[i].shopIdx)
                }
                scratch(pics[0],pics[idx])
            }
        }
    })
})

    
</script>
</html>